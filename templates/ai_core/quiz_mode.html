{% extends 'base/index.html' %}

{% block page_content %}
<div class="container mt-5" style="padding-top: 80px;">
    <!-- Header Section -->
    <div class="text-center mb-5">
        <h1 class="display-4" style="color: #008000;">AI Quiz Mode</h1>
        <p class="lead text-muted">Test your knowledge with AI-generated quizzes tailored for Sierra Leone students.</p>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Setup Form -->
    <div id="quiz-setup" {% if quiz_data %}style="display:none;"{% endif %}>
        <div class="card shadow-lg border-light rounded">
            <div class="card-body">
                <form method="post" id="quiz-form">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="topic" class="form-label fs-5 fw-bold">Topic:</label>
                        <input type="text" class="form-control" id="topic" name="topic" placeholder="e.g., Photosynthesis, World War II, Algebra" required>
                    </div>
                    <div class="mb-4">
                        <label for="subject" class="form-label fs-5 fw-bold">Subject:</label>
                        <input type="text" class="form-control" id="subject" name="subject" placeholder="e.g., Biology, History, Mathematics" required>
                    </div>
                    <div class="mb-4">
                        <label for="level" class="form-label fs-5 fw-bold">Class Level:</label>
                        <select class="form-select" id="level" name="level" required>
                            {% for value, label in class_levels %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fs-5 fw-bold">Number of Questions:</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="num_questions" id="q5" value="5" checked>
                                <label class="form-check-label" for="q5">5</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="num_questions" id="q10" value="10">
                                <label class="form-check-label" for="q10">10</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="num_questions" id="q15" value="15">
                                <label class="form-check-label" for="q15">15</label>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-lg text-white" style="background-color: #008000;" id="generate-btn">
                            Generate Quiz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quiz Playing Area (hidden until quiz starts) -->
    <div id="quiz-playing" style="display:none;">
        <!-- Progress Bar -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-bold" id="quiz-progress-text">Question 1 of 5</span>
                <span class="badge fs-6" style="background-color: #008000;" id="quiz-score-badge">Score: 0</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" style="width: 0%; background-color: #008000;" id="quiz-progress-bar"></div>
            </div>
        </div>

        <!-- Timer -->
        <div class="text-center mb-3">
            <div class="d-inline-flex align-items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 36 36" id="timer-svg">
                    <circle cx="18" cy="18" r="16" fill="none" stroke="#e9ecef" stroke-width="3"></circle>
                    <circle cx="18" cy="18" r="16" fill="none" stroke="#008000" stroke-width="3"
                            stroke-dasharray="100.53" stroke-dashoffset="0"
                            stroke-linecap="round" transform="rotate(-90 18 18)" id="timer-circle"></circle>
                </svg>
                <span class="fs-4 fw-bold" id="timer-text" style="color: #008000;">30</span>
            </div>
        </div>

        <!-- Question Card -->
        <div class="card shadow-lg border-light rounded">
            <div class="card-body p-4">
                <h4 class="card-title mb-4" id="quiz-question"></h4>
                <div id="quiz-options" class="d-grid gap-3"></div>
            </div>
        </div>

        <!-- Feedback -->
        <div id="quiz-feedback" class="mt-3 p-3 rounded text-center fw-bold fs-5" style="display:none;"></div>
    </div>

    <!-- Results Section (hidden until quiz ends) -->
    <div id="quiz-results" style="display:none;">
        <div id="confetti-container"></div>

        <div class="card shadow-lg border-light rounded text-center p-5">
            <h2 class="mb-3" style="color: #008000;">Quiz Complete!</h2>
            <div class="display-1 fw-bold mb-2" id="result-score" style="color: #008000;"></div>
            <p class="fs-4 text-muted" id="result-percentage"></p>
            <div class="d-flex justify-content-center gap-3 mt-4">
                <button class="btn btn-lg text-white" style="background-color: #008000;" onclick="location.reload()">Try Again</button>
                <button class="btn btn-lg btn-outline-success" id="save-score-btn">Save Score</button>
            </div>
        </div>

        <!-- Question Review -->
        <div class="mt-4" id="question-review"></div>
    </div>
</div>

{% if quiz_data %}
{{ quiz_data|json_script:"quiz-data" }}
<script>
    var QUIZ_META = {
        topic: "{{ topic|escapejs }}",
        subject: "{{ subject|escapejs }}",
        level: "{{ level|escapejs }}",
        totalQuestions: {{ num_questions }}
    };
</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    // Loading spinner on form submit
    var form = document.getElementById('quiz-form');
    if (form) {
        form.addEventListener('submit', function() {
            var btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Generating Quiz...';
        });
    }

    // Quiz engine
    var dataEl = document.getElementById('quiz-data');
    if (!dataEl) return;

    var quizData = JSON.parse(dataEl.textContent);
    if (!Array.isArray(quizData) || quizData.length === 0) return;

    var currentIndex = 0;
    var score = 0;
    var userAnswers = [];
    var timerInterval = null;
    var timeLeft = 30;
    var answered = false;

    var setupEl = document.getElementById('quiz-setup');
    var playingEl = document.getElementById('quiz-playing');
    var resultsEl = document.getElementById('quiz-results');

    // Start quiz
    setupEl.style.display = 'none';
    playingEl.style.display = 'block';
    showQuestion();

    function showQuestion() {
        answered = false;
        var q = quizData[currentIndex];
        document.getElementById('quiz-question').textContent = (currentIndex + 1) + ". " + q.question;
        document.getElementById('quiz-progress-text').textContent = "Question " + (currentIndex + 1) + " of " + quizData.length;
        document.getElementById('quiz-progress-bar').style.width = ((currentIndex / quizData.length) * 100) + "%";
        document.getElementById('quiz-score-badge').textContent = "Score: " + score;
        document.getElementById('quiz-feedback').style.display = 'none';

        var optionsEl = document.getElementById('quiz-options');
        optionsEl.innerHTML = '';
        var labels = ['A', 'B', 'C', 'D'];
        q.options.forEach(function(opt, i) {
            var btn = document.createElement('button');
            btn.className = 'btn btn-outline-dark btn-lg text-start quiz-option-btn';
            btn.innerHTML = '<strong>' + labels[i] + '.</strong> ' + escapeHtml(opt);
            btn.dataset.index = i;
            btn.addEventListener('click', function() { selectAnswer(i); });
            optionsEl.appendChild(btn);
        });

        startTimer();
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    function startTimer() {
        timeLeft = 30;
        updateTimerDisplay();
        clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (!answered) {
                    selectAnswer(-1);
                }
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        document.getElementById('timer-text').textContent = timeLeft;
        var circle = document.getElementById('timer-circle');
        var offset = (1 - timeLeft / 30) * 100.53;
        circle.setAttribute('stroke-dashoffset', offset);
        if (timeLeft <= 10) {
            document.getElementById('timer-text').style.color = '#dc3545';
            circle.setAttribute('stroke', '#dc3545');
        } else {
            document.getElementById('timer-text').style.color = '#008000';
            circle.setAttribute('stroke', '#008000');
        }
    }

    function selectAnswer(selectedIndex) {
        if (answered) return;
        answered = true;
        clearInterval(timerInterval);

        var q = quizData[currentIndex];
        var correct = q.correct;
        var isCorrect = selectedIndex === correct;
        userAnswers.push(selectedIndex);

        if (isCorrect) score++;

        var buttons = document.querySelectorAll('.quiz-option-btn');
        buttons.forEach(function(btn, i) {
            btn.disabled = true;
            if (i === correct) {
                btn.classList.remove('btn-outline-dark');
                btn.classList.add('btn-success', 'text-white');
            } else if (i === selectedIndex && !isCorrect) {
                btn.classList.remove('btn-outline-dark');
                btn.classList.add('btn-danger', 'text-white');
            }
        });

        var feedbackEl = document.getElementById('quiz-feedback');
        feedbackEl.style.display = 'block';
        if (selectedIndex === -1) {
            feedbackEl.style.backgroundColor = '#fff3cd';
            feedbackEl.style.color = '#856404';
            feedbackEl.textContent = "Time's up! The answer is " + q.options[correct] + ". " + (q.explanation || '');
        } else if (isCorrect) {
            feedbackEl.style.backgroundColor = '#d4edda';
            feedbackEl.style.color = '#155724';
            feedbackEl.textContent = "Correct! " + (q.explanation || '');
        } else {
            feedbackEl.style.backgroundColor = '#f8d7da';
            feedbackEl.style.color = '#721c24';
            feedbackEl.textContent = "Wrong! The answer is " + q.options[correct] + ". " + (q.explanation || '');
        }

        document.getElementById('quiz-score-badge').textContent = "Score: " + score;

        setTimeout(function() {
            currentIndex++;
            if (currentIndex < quizData.length) {
                showQuestion();
            } else {
                showResults();
            }
        }, 2500);
    }

    // Keyboard support (1-4 keys)
    document.addEventListener('keydown', function(e) {
        if (playingEl.style.display !== 'block' || answered) return;
        var key = parseInt(e.key);
        if (key >= 1 && key <= 4) {
            selectAnswer(key - 1);
        }
    });

    function showResults() {
        playingEl.style.display = 'none';
        resultsEl.style.display = 'block';

        var pct = Math.round((score / quizData.length) * 100);
        document.getElementById('result-score').textContent = score + " / " + quizData.length;
        document.getElementById('result-percentage').textContent = pct + "% correct";
        document.getElementById('quiz-progress-bar').style.width = "100%";

        createConfetti();

        var reviewEl = document.getElementById('question-review');
        var labels = ['A', 'B', 'C', 'D'];
        quizData.forEach(function(q, i) {
            var userAns = userAnswers[i];
            var isCorrect = userAns === q.correct;
            var card = document.createElement('div');
            card.className = 'card shadow-sm rounded mb-3';

            var userAnsText = userAns === -1 ? 'No answer (time ran out)' : labels[userAns] + '. ' + q.options[userAns];
            var correctAnsText = labels[q.correct] + '. ' + q.options[q.correct];

            var html = '<div class="card-body">' +
                '<div class="d-flex align-items-start gap-2 mb-2">' +
                    '<span class="badge ' + (isCorrect ? 'bg-success' : 'bg-danger') + '">' + (isCorrect ? 'Correct' : 'Wrong') + '</span>' +
                    '<strong>' + (i + 1) + '. ' + escapeHtml(q.question) + '</strong>' +
                '</div>' +
                '<p class="mb-1">Your answer: <strong>' + escapeHtml(userAnsText) + '</strong></p>';
            if (!isCorrect) {
                html += '<p class="mb-1 text-success">Correct answer: <strong>' + escapeHtml(correctAnsText) + '</strong></p>';
            }
            html += '<p class="text-muted mb-0"><em>' + escapeHtml(q.explanation || '') + '</em></p></div>';

            card.innerHTML = html;
            reviewEl.appendChild(card);
        });

        // Save score button
        document.getElementById('save-score-btn').addEventListener('click', function() {
            var btn = this;
            btn.disabled = true;
            btn.textContent = 'Saving...';

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            var token = csrfToken ? csrfToken.value : '';

            fetch("{% url 'ai_core:quiz_save' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': token
                },
                body: JSON.stringify({
                    topic: QUIZ_META.topic,
                    subject: QUIZ_META.subject,
                    level: QUIZ_META.level,
                    score: score,
                    total_questions: quizData.length,
                    quiz_data: quizData
                })
            }).then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.status === 'ok') {
                    btn.textContent = 'Saved!';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-success', 'text-white');
                } else {
                    btn.textContent = 'Error - Try Again';
                    btn.disabled = false;
                }
            }).catch(function() {
                btn.textContent = 'Error - Try Again';
                btn.disabled = false;
            });
        });
    }

    function createConfetti() {
        var container = document.getElementById('confetti-container');
        var colors = ['#008000', '#f9b234', '#1e90ff', '#ff6347', '#9b59b6', '#2ecc71', '#e74c3c', '#3498db'];
        for (var i = 0; i < 60; i++) {
            var piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + '%';
            piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDelay = Math.random() * 3 + 's';
            piece.style.animationDuration = (2 + Math.random() * 3) + 's';
            container.appendChild(piece);
        }
        setTimeout(function() { container.innerHTML = ''; }, 6000);
    }
})();
</script>
{% endblock %}

{% block style %}
<style>
    .quiz-option-btn {
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 1.05rem;
        transition: all 0.2s;
    }
    .quiz-option-btn:hover:not(:disabled) {
        background-color: #008000;
        color: white;
        border-color: #008000;
    }

    /* Confetti */
    #confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
    }
    .confetti-piece {
        position: absolute;
        top: -10px;
        width: 10px;
        height: 10px;
        opacity: 0.9;
        animation: confetti-fall linear forwards;
    }
    .confetti-piece:nth-child(odd) {
        border-radius: 50%;
    }
    .confetti-piece:nth-child(3n) {
        width: 8px;
        height: 14px;
    }
    @keyframes confetti-fall {
        0% {
            transform: translateY(-10px) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    #timer-text {
        transition: color 0.3s;
        min-width: 30px;
        text-align: center;
    }

    .form-check-input:checked {
        background-color: #008000;
        border-color: #008000;
    }
</style>
{% endblock %}
